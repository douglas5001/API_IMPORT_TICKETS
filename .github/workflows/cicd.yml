name: CI/CD Pipeline - API_IMPORT_TICKETS

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # ==========================================================
  #  JOB 1 â€” QUALITY CHECKS (lint, type-check, security)
  # ==========================================================
  quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff mypy bandit pip-audit

      # LINT - Ruff
      - name: Lint - ruff
        run: ruff check .

      # TYPE CHECK - mypy
      - name: Type checking - mypy
        run: mypy app/

      # SECURITY - bandit
      - name: SeguranÃ§a - bandit
        run: bandit -r app/ -x app/tests

      # DEPENDENCY SECURITY - pip-audit
      - name: Auditoria de dependÃªncias - pip-audit
        run: pip-audit || true   # nÃ£o interrompe pipeline se houver CVEs


  # ==========================================================
  #  JOB 2 â€” TESTES COMPLETOS (CI)
  # ==========================================================
  tests:
    runs-on: ubuntu-latest
    needs: quality

    services:
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    env:
      PYTEST_RUNNING: "1"    # <===== ESSENCIAL
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_HOST: localhost
      DB_PORT: 5432
      DB_NAME: test_db
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@localhost:5432/test_db

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Aguardar PostgreSQL
        run: |
          for i in {1..10}; do
            pg_isready -h localhost -p 5432 && break
            sleep 2
          done

      - name: Rodar migraÃ§Ãµes
        run: alembic upgrade head

      - name: Rodar Testes (pytest)
        run: pytest -v

  # ==========================================================
  #  JOB 3 â€” DOCKER BUILD TEST (antes do deploy)
  # ==========================================================
  docker_build:
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Testar build Docker
        run: docker build -t api_import_tickets:test .


  # ==========================================================
  #  JOB 4 â€” DEPLOY (SELF-HOSTED)
  # ==========================================================
  deploy:
    runs-on: self-hosted
    needs: docker_build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy local no servidor
        run: |
          cd "${{ secrets.SERVER_PATH }}"

          echo "Atualizando cÃ³digo no servidor..."
          git fetch --all
          git reset --hard origin/main

          echo "Subindo containers..."
          docker compose down || true
          docker compose up -d --build

          echo "Executando migraÃ§Ãµes..."
          docker compose exec -T api alembic upgrade head

          echo "Realizando health-check..."
          sleep 5
          curl -f http://localhost:8001/api/v1/health || (echo "âŒ Health-check falhou!" && exit 1)

          echo "Deploy concluÃ­do com sucesso! ðŸŽ‰"


  # ==========================================================
  #  JOB 5 â€” NOTIFICAÃ‡ÃƒO DE FALHA
  # ==========================================================
  notify_failure:
    needs: [quality, tests, docker_build, deploy]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notificar falha (log no Actions)
        run: echo "âŒ O pipeline falhou!"
